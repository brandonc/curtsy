<!DOCTYPE html />
<html>
<head>
	<title>EmbeddedResources.cs</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<link href="explain.css" rel="stylesheet" media="all" type="text/css" />
	<script src="prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
	<div id="container">
		<div id="background"></div>
			<div id="jump_to">
				Jump To &hellip;
				<div id="jump_wrapper">
					<div id="jump_page">
							<a class="source" href="explain.html">
								Explain.cs
							</a>
							<a class="source" href="extensions/stringregexextensions.html">
								Extensions\StringRegexExtensions.cs
							</a>
							<a class="source" href="parser,lexer.html">
								Parser,Lexer.cs
							</a>
							<a class="source" href="pathhelper.html">
								PathHelper.cs
							</a>
							<a class="source" href="program.html">
								Program.cs
							</a>
							<a class="source" href="properties/assemblyinfo.html">
								Properties\AssemblyInfo.cs
							</a>
							<a class="source" href="embeddedresources.html">
								EmbeddedResources.cs
							</a>
							<a class="source" href="section.html">
								Section.cs
							</a>
							<a class="source" href="templatebase.html">
								TemplateBase.cs
							</a>
							<a class="source" href="typemap.html">
								TypeMap.cs
							</a>
					</div>
				</div>
			</div>
		<table cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th class="docs">
						<h1>EmbeddedResources.cs</h1>
					</th>
					<th class="code"></th>
				</tr>
			</thead>
			<tbody>
					<tr id="section_1">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_1">&#182;</a>
							</div>
							
						</td>
						<td class="code">
							<pre><code class='prettyprint'>using System;
using System.CodeDom.Compiler;
using System.IO;
using System.Linq;
using System.Web.Razor;
using System.Text;

namespace Explain
{
    public class EmbeddedResources
    {
        Type templateType = null;
        string[] clientFiles = { &quot;prettify.js&quot;, &quot;explain.css&quot; };

        public void WriteClientFilesTo(string path)
        {
            Directory.CreateDirectory(path);

            foreach (string res in clientFiles)
            {
                string outputFile = Path.Combine(path, res);

                if (File.Exists(outputFile))
                    continue;

                try
                {
                    using (var writer = File.CreateText(outputFile))
                    {
                        Stream s = System.Reflection.Assembly.GetExecutingAssembly().GetManifestResourceStream(&quot;Explain.Resources.&quot; + res);
                        if (s == null)
                            throw new InvalidDataException(&quot;Could not find embedded resource &#39;Explain.Resources.&quot; + res + &quot;&#39;&quot;);

                        using (var reader = new StreamReader(s))
                        {
                            writer.Write(reader.ReadToEnd());
                        }
                    }
                }
                catch
                {
                    try { File.Delete(outputFile); } catch { }
                }
            }
        }

        public <a href="templatebase.html">TemplateBase</a> CreateRazorTemplateInstance()
        {
            if (templateType == null)
            {
                var host = new RazorEngineHost(new CSharpRazorCodeLanguage());
                host.DefaultBaseClass = typeof(TemplateBase).FullName;
                host.DefaultNamespace = &quot;RazorOutput&quot;;
                host.DefaultClassName = &quot;Template&quot;;
                host.NamespaceImports.Add(&quot;System&quot;);

                GeneratorResults razorResult = null;

                var templateStream = System.Reflection.Assembly.GetExecutingAssembly().GetManifestResourceStream(&quot;Explain.Resources.explain.cshtml&quot;);

                if (templateStream == null)
                    throw new FileNotFoundException(&quot;Could not find embedded resource &#39;Explain.Resources.explain.cshtml&#39;&quot;);

                using (var reader = new StreamReader(templateStream))
                {
                    razorResult = new RazorTemplateEngine(host).GenerateCode(reader);
                }

                var compilerParams = new CompilerParameters
                {
                    GenerateInMemory = true,
                    GenerateExecutable = false,
                    IncludeDebugInformation = false,
                    CompilerOptions = &quot;/target:library /optimize&quot;
                };
                compilerParams.ReferencedAssemblies.Add(typeof(Program).Assembly.CodeBase.Replace(&quot;file:///&quot;, &quot;&quot;).Replace(&#39;/&#39;, Path.DirectorySeparatorChar));

                var codeProvider = new Microsoft.CSharp.CSharpCodeProvider();
                var results = codeProvider.CompileAssemblyFromDom(compilerParams, razorResult.GeneratedCode);

</code></pre>
						</td>
					</tr>
					<tr id="section_2">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_2">&#182;</a>
							</div>
							<p>Check for errors that may have occurred during template generation</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>                if (results.Errors.HasErrors)
                {
                    StringBuilder errors = new StringBuilder();
                    foreach (var err in results.Errors.OfType&lt;CompilerError&gt;().Where(ce =&gt; !ce.IsWarning))
                        errors.AppendFormat(&quot;Error compiling template: ({0}, {1}) {2}&quot;, err.Line, err.Column, err.ErrorText);

                    throw new InvalidDataException(errors.ToString());
                }

                templateType = results.CompiledAssembly.GetType(&quot;RazorOutput.Template&quot;);
            }

            return (TemplateBase)Activator.CreateInstance(templateType);
        }
    }
}

</code></pre>
						</td>
					</tr>
			</tbody>
		</table>
	</div>
</body>
</html>
