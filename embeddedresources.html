<!DOCTYPE html />
<html>
<head>
	<title>EmbeddedResources.cs</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<link href="explain.css" rel="stylesheet" media="all" type="text/css" />
	<script src="prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
	<div id="container">
		<div id="background"></div>
			<div id="sources" class="dd">
				EmbeddedResources.cs
                <div class="ddbtn"></div>
                <header></header>
                <nav>
                    <table border="0" cellspacing="0">
							<tr>
                                <td class="size">8.35 KB</td>
                                <td><a class="source" href="explain.html">
								    Explain.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">37.19 KB</td>
                                <td><a class="source" href="extensions/stringregexextensions.html">
								    Extensions\StringRegexExtensions.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">12.34 KB</td>
                                <td><a class="source" href="parser,lexer.html">
								    Parser,Lexer.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">898 B</td>
                                <td><a class="source" href="pathhelper.html">
								    PathHelper.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">3.16 KB</td>
                                <td><a class="source" href="program.html">
								    Program.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">1.46 KB</td>
                                <td><a class="source" href="properties/assemblyinfo.html">
								    Properties\AssemblyInfo.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">3.79 KB</td>
                                <td><a class="source" href="embeddedresources.html">
								    EmbeddedResources.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">506 B</td>
                                <td><a class="source" href="section.html">
								    Section.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">1.05 KB</td>
                                <td><a class="source" href="templatebase.html">
								    TemplateBase.cs
							    </a></td>
                            </tr>
							<tr>
                                <td class="size">1.3 KB</td>
                                <td><a class="source" href="typemap.html">
								    TypeMap.cs
							    </a></td>
                            </tr>
                    </table>
				</nav>
			</div>
		<table cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th class="docs">
						<h1>EmbeddedResources.cs</h1>
					</th>
                    <th class="lines"></th>
					<th class="code">&nbsp;</th>
				</tr>
			</thead>
			<tbody>
					<tr id="section_1">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_1">&#182;</a>
							</div>
							
						</td>
                        <td class="lines">
1<br />
2<br />
3<br />
4<br />
5<br />
6<br />
7<br />
8<br />
9<br />
10<br />
11<br />
12<br />
13<br />
14<br />
15<br />
16<br />
17<br />
18<br />
19<br />
20<br />
21<br />
22<br />
23<br />
24<br />
25<br />
26<br />
27<br />
28<br />
29<br />
30<br />
31<br />
32<br />
33<br />
34<br />
35<br />
36<br />
37<br />
38<br />
39<br />
40<br />
41<br />
42<br />
43<br />
44<br />
45<br />
46<br />
47<br />
48<br />
49<br />
50<br />
51<br />
52<br />
53<br />
54<br />
55<br />
56<br />
57<br />
58<br />
59<br />
60<br />
61<br />
62<br />
63<br />
64<br />
65<br />
66<br />
67<br />
68<br />
69<br />
70<br />
71<br />
72<br />
73<br />
74<br />
75<br />
76<br />
77<br />
78<br />
79<br />
80<br />
81<br />
                        </td>
						<td class="code">
							<pre><code class='prettyprint'>using System;
using System.CodeDom.Compiler;
using System.IO;
using System.Linq;
using System.Web.Razor;
using System.Text;

namespace Explain
{
    public class EmbeddedResources
    {
        Type templateType = null;
        string[] clientFiles = { &quot;prettify.js&quot;, &quot;explain.css&quot; };

        public void WriteClientFilesTo(string path)
        {
            Directory.CreateDirectory(path);

            foreach (string res in clientFiles)
            {
                string outputFile = Path.Combine(path, res);

                if (File.Exists(outputFile))
                    continue;

                try
                {
                    using (var writer = File.CreateText(outputFile))
                    {
                        Stream s = System.Reflection.Assembly.GetExecutingAssembly().GetManifestResourceStream(&quot;Explain.Resources.&quot; + res);
                        if (s == null)
                            throw new InvalidDataException(&quot;Could not find embedded resource &#39;Explain.Resources.&quot; + res + &quot;&#39;&quot;);

                        using (var reader = new StreamReader(s))
                        {
                            writer.Write(reader.ReadToEnd());
                        }
                    }
                }
                catch
                {
                    try { File.Delete(outputFile); } catch { }
                }
            }
        }

        public <a href="templatebase.html">TemplateBase</a> CreateRazorTemplateInstance()
        {
            if (templateType == null)
            {
                var host = new RazorEngineHost(new CSharpRazorCodeLanguage());
                host.DefaultBaseClass = typeof(TemplateBase).FullName;
                host.DefaultNamespace = &quot;RazorOutput&quot;;
                host.DefaultClassName = &quot;Template&quot;;
                host.NamespaceImports.Add(&quot;System&quot;);

                GeneratorResults razorResult = null;

                var templateStream = System.Reflection.Assembly.GetExecutingAssembly().GetManifestResourceStream(&quot;Explain.Resources.explain.cshtml&quot;);

                if (templateStream == null)
                    throw new FileNotFoundException(&quot;Could not find embedded resource &#39;Explain.Resources.explain.cshtml&#39;&quot;);

                using (var reader = new StreamReader(templateStream))
                {
                    razorResult = new RazorTemplateEngine(host).GenerateCode(reader);
                }

                var compilerParams = new CompilerParameters
                {
                    GenerateInMemory = true,
                    GenerateExecutable = false,
                    IncludeDebugInformation = false,
                    CompilerOptions = &quot;/target:library /optimize&quot;
                };
                compilerParams.ReferencedAssemblies.Add(typeof(Program).Assembly.CodeBase.Replace(&quot;file:///&quot;, &quot;&quot;).Replace(&#39;/&#39;, Path.DirectorySeparatorChar));

                var codeProvider = new Microsoft.CSharp.CSharpCodeProvider();
                var results = codeProvider.CompileAssemblyFromDom(compilerParams, razorResult.GeneratedCode);

</code></pre>
						</td>
					</tr>
					<tr id="section_2">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_2">&#182;</a>
							</div>
							<p>Check for errors that may have occurred during template generation</p>

						</td>
                        <td class="lines">
82<br />
83<br />
84<br />
85<br />
86<br />
87<br />
88<br />
89<br />
90<br />
91<br />
92<br />
93<br />
94<br />
95<br />
96<br />
97<br />
98<br />
                        </td>
						<td class="code">
							<pre><code class='prettyprint'>                if (results.Errors.HasErrors)
                {
                    StringBuilder errors = new StringBuilder();
                    foreach (var err in results.Errors.OfType&lt;CompilerError&gt;().Where(ce =&gt; !ce.IsWarning))
                        errors.AppendFormat(&quot;Error compiling template: ({0}, {1}) {2}&quot;, err.Line, err.Column, err.ErrorText);

                    throw new InvalidDataException(errors.ToString());
                }

                templateType = results.CompiledAssembly.GetType(&quot;RazorOutput.Template&quot;);
            }

            return (TemplateBase)Activator.CreateInstance(templateType);
        }
    }
}

</code></pre>
						</td>
					</tr>
			</tbody>
		</table>
	</div>
</body>
</html>